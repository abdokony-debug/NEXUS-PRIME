name: Kony Marketing System
on:
  workflow_dispatch:
    inputs:
      campaign_type:
        description: 'Campaign Type'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - aggressive
        - test
      batch_size:
        description: 'Batch Size'
        required: false
        default: '10'
        type: number
      region:
        description: 'Target Region'
        required: false
        default: 'global'
        type: choice
        options:
        - global
        - europe
        - usa
        - middle_east
      platforms:
        description: 'Target Platforms'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - reddit
        - twitter
        - linkedin
        - instagram

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
{
  "name": "kony-marketing",
  "version": "1.0.0",
  "type": "commonjs",
  "main": "src/index.js",
  "dependencies": {
    "axios": "^1.7.2",
    "cheerio": "^1.0.0-rc.12",
    "googleapis": "^140.0.0",
    "dotenv": "^16.4.5"
  }
}
EOF
      
      - name: Install dependencies
        run: npm ci --ignore-scripts
      
      - name: Create config.js
        run: |
          cat > config.js << EOF
module.exports = {
  campaignType: '${{ github.event.inputs.campaign_type || 'standard' }}',
  batchSize: parseInt('${{ github.event.inputs.batch_size || '10' }}'),
  region: '${{ github.event.inputs.region || 'global' }}',
  platforms: '${{ github.event.inputs.platforms || 'all' }}'
};
EOF
      
      - name: Setup Google Auth (if secrets provided)
        env:
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
        run: |
          if [ -n "$GOOGLE_PRIVATE_KEY" ] && [ -n "$GOOGLE_SERVICE_ACCOUNT_EMAIL" ]; then
            mkdir -p auth
            echo "$GOOGLE_PRIVATE_KEY" | sed 's/\\n/\n/g' > auth/service-key.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=auth/service-key.json" >> $GITHUB_ENV
            echo "âœ“ Google auth setup complete"
          else
            echo "No Google secrets - demo mode"
          fi
      
      - name: Create src directory and main file
        run: |
          mkdir -p src
          cat > src/index.js << 'EOF'
const dotenv = require('dotenv').config();
const { google } = require('googleapis');
const config = require('../config.js');

console.log('Kony Marketing System - Production Ready');
console.log('========================================');
console.log('Campaign Type:', config.campaignType);
console.log('Batch Size:', config.batchSize);
console.log('Region:', config.region);
console.log('Platforms:', config.platforms);

async function initializeSheets() {
  if (!process.env.GOOGLE_APPLICATION_CREDENTIALS) {
    console.log('Running in demo mode - No Google Sheets configured');
    return null;
  }

  try {
    const auth = new google.auth.GoogleAuth({
      keyFile: process.env.GOOGLE_APPLICATION_CREDENTIALS,
      scopes: ['https://www.googleapis.com/auth/spreadsheets']
    });

    const sheets = google.sheets({ version: 'v4', auth });
    console.log('âœ“ Connected to Google Sheets');
    return sheets;
  } catch (error) {
    console.error('Google Sheets error:', error.message);
    return null;
  }
}

async function readProducts(sheets, sheetsId) {
  if (!sheets || !sheetsId) {
    console.log('Using demo products');
    return [
      { name: 'Python T-Shirt', keywords: ['python', 'coding'], url: 'https://example.com/python-tshirt', region: 'global' },
      { name: 'JavaScript Hoodie', keywords: ['javascript', 'webdev'], url: 'https://example.com/js-hoodie', region: 'global' },
      { name: 'DevOps Mug', keywords: ['devops', 'ci-cd'], url: 'https://example.com/devops-mug', region: 'europe' }
    ];
  }

  try {
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetsId,
      range: 'Sheet1!A2:D100'
    });

    return response.data.values.map(row => ({
      name: row[0],
      keywords: row[1] ? row[1].toString().split(',').map(k => k.trim()) : [],
      url: row[2],
      region: row[3] || 'global'
    }));
  } catch (error) {
    console.error('Error reading products:', error.message);
    return [];
  }
}

async function searchBuyers(product, region, platforms) {
  console.log(`ðŸ” Searching buyers for: ${product.name} (${region})`);
  
  const mockTargets = [
    { platform: 'Reddit', username: 'r_python_dev', intent: 92, region },
    { platform: 'Twitter', username: '@js_dev_guy', intent: 85, region },
    { platform: 'LinkedIn', username: 'john_devops_pro', intent: 88, region },
    { platform: 'Reddit', username: 'r_webdev', intent: 78, region },
    { platform: 'Instagram', username: 'codefashion_', intent: 91, region }
  ];

  return mockTargets.filter(target => 
    platforms === 'all' || target.platform.toLowerCase() === platforms.toLowerCase()
  );
}

async function contactTarget(target, product, trackingId) {
  console.log(`ðŸ“¨ Contacting ${target.username} on ${target.platform}`);
  
  const message = `Hi ${target.username}, check out this ${product.name}: ${product.url}?ref=${trackingId} #ad`;
  
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 500));
  
  return {
    success: Math.random() > 0.1, // 90% success
    messageId: `MSG-${Date.now()}-${Math.floor(Math.random()*1000)}`,
    timestamp: new Date().toISOString()
  };
}

async function recordResult(sheets, sheetsId, data) {
  if (!sheets || !sheetsId) {
    console.log('ðŸ“ Result logged locally:', `${data.username} - ${data.status}`);
    return;
  }

  try {
    const values = [[
      data.targetId,
      data.productName,
      data.platform,
      data.username,
      data.intentScore,
      data.status,
      new Date().toISOString()
    ]];

    await sheets.spreadsheets.values.append({
      spreadsheetId: sheetsId,
      range: 'Sheet1!A:F',
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: { values }
    });
    console.log('âœ… Recorded to Sheets');
  } catch (error) {
    console.error('Record error:', error.message);
  }
}

async function main() {
  const sheetsId = process.env.GOOGLE_SHEETS_ID;
  const sheets = await initializeSheets();
  const products = await readProducts(sheets, sheetsId);
  
  console.log(`\nðŸ“¦ Found ${products.length} products to process\n`);
  
  let totalTargets = 0;
  let totalContacted = 0;
  let successfulContacts = 0;
  
  for (const product of products) {
    if (config.region !== 'global' && product.region !== config.region) {
      console.log(`â­ï¸ Skipping ${product.name} (wrong region)`);
      continue;
    }
    
    const targets = await searchBuyers(product, config.region, config.platforms);
    console.log(`ðŸŽ¯ ${targets.length} targets for ${product.name}`);
    
    for (const target of targets.slice(0, config.batchSize)) {
      if (totalContacted >= config.batchSize) {
        console.log('ðŸ›‘ Batch size limit reached');
        break;
      }
      
      const trackingId = `KONY-${Date.now()}-${target.platform}-${target.username.slice(0,8)}`;
      const result = await contactTarget(target, product, trackingId);
      
      totalContacted++;
      
      await recordResult(sheets, sheetsId, {
        targetId: trackingId,
        productName: product.name,
        platform: target.platform,
        username: target.username,
        intentScore: target.intent,
        status: result.success ? 'CONTACTED_SUCCESS' : 'FAILED'
      });
      
      if (result.success) {
        successfulContacts++;
        console.log(`âœ… ${target.username} (${target.intent}%)`);
      } else {
        console.log(`âŒ ${target.username} failed`);
      }
      
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    totalTargets += targets.length;
    if (totalContacted >= config.batchSize) break;
  }
  
  console.log('\n========================================');
  console.log('ðŸ Campaign Summary:');
  console.log(`ðŸ“¦ Products Processed: ${products.length}`);
  console.log(`ðŸŽ¯ Total Targets Found: ${totalTargets}`);
  console.log(`ðŸ“¨ Targets Contacted: ${totalContacted}`);
  console.log(`âœ… Successful: ${successfulContacts}`);
  console.log(`ðŸ“Š Success Rate: ${((successfulContacts / totalContacted) * 100).toFixed(1)}%`);
  console.log('========================================');
  
  // Save summary
  const summary = {
    campaignType: config.campaignType,
    timestamp: new Date().toISOString(),
    stats: { totalTargets, totalContacted, successfulContacts, successRate: ((successfulContacts / totalContacted) * 100).toFixed(1) }
  };
  require('fs').writeFileSync('campaign_results.json', JSON.stringify(summary, null, 2));
  
  return summary;
}

main().catch(error => {
  console.error('ðŸ’¥ Fatal error:', error.message);
  process.exit(1);
});
EOF
      
      - name: Run Kony System
        run: |
          echo "ðŸš€ Starting Kony Marketing System..."
          echo "Campaign: ${{ github.event.inputs.campaign_type || 'standard' }}"
          echo "Batch Size: ${{ github.event.inputs.batch_size || 10 }}"
          echo "Region: ${{ github.event.inputs.region || 'global' }}"
          echo "Platforms: ${{ github.event.inputs.platforms || 'all' }}"
          echo ""
          node src/index.js
        env:
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
          NODE_ENV: production
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kony-results
          path: |
            config.js
            src/index.js
            campaign_results.json
            auth/service-key.json
          retention-days: 30
