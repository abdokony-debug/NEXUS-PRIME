name: Kony Marketing System
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Campaign Mode'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - aggressive
          - test
      batch_size:
        description: 'Batch Size'
        required: false
        default: '10'
        type: number
      region:
        description: 'Target Region'
        required: false
        default: 'global'
        type: choice
        options:
          - global
          - europe
          - usa
          - middle_east

jobs:
  kony-campaign:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create package.json if missing
        run: |
          if [ ! -f "package.json" ]; then
            echo "Creating package.json..."
            cat > package.json << EOF
{
  "name": "kony-marketing",
  "version": "1.0.0",
  "description": "Kony Marketing Automation System",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "axios": "^1.6.0",
    "cheerio": "^1.0.0",
    "dotenv": "^16.3.0",
    "googleapis": "^128.0.0",
    "puppeteer": "^21.0.0"
  }
}
EOF
            echo "package.json created"
          fi

      - name: Generate package-lock.json
        run: npm i --package-lock-only

      - name: Install dependencies
        run: npm ci

      - name: Setup environment
        run: |
          if [ -f "env.example" ]; then
            cp env.example .env
          else
            touch .env
          fi
          
          {
            echo "GOOGLE_SHEETS_ID=${{ secrets.GOOGLE_SHEETS_ID }}"
            echo "GOOGLE_SERVICE_ACCOUNT_EMAIL=${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}"
            echo "GOOGLE_PRIVATE_KEY='${{ secrets.GOOGLE_PRIVATE_KEY }}'"
            echo "KONY_MODE=${{ github.event.inputs.mode }}"
            echo "KONY_BATCH_SIZE=${{ github.event.inputs.batch_size }}"
            echo "KONY_REGION=${{ github.event.inputs.region }}"
          } >> .env

      - name: Run Kony System
        run: |
          if [ -f "index.js" ]; then
            node index.js
          elif [ -f "src/index.js" ]; then
            node src/index.js
          else
            echo "Creating basic index.js..."
            cat > index.js << EOF
const fs = require('fs');
const path = require('path');

console.log('Kony Marketing System - Basic Version');
console.log('Mode:', process.env.KONY_MODE || 'standard');
console.log('Batch Size:', process.env.KONY_BATCH_SIZE || '10');
console.log('Region:', process.env.KONY_REGION || 'global');

// Simulate campaign
console.log('\nSimulating campaign...');
setTimeout(() => {
  console.log('Campaign simulation completed');
  console.log('Targets processed: 5');
  console.log('Messages sent: 3');
  console.log('Success rate: 60%');
}, 2000);
EOF
            node index.js
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kony-results
          path: .env
          retention-days: 1
