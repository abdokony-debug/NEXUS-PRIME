# .github/workflows/kony-marketing.yml
name: ğŸš€ Kony Marketing System
on: 
  workflow_dispatch:
    inputs:
      mode:
        description: 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - aggressive
        - test
        - research-only
        
      batch_size:
        description: 'Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©'
        required: false
        default: '10'
        type: number
        
      region:
        description: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©'
        required: false
        default: 'global'
        type: choice
        options:
        - global
        - europe
        - usa
        - middle_east
        
      platforms:
        description: 'Ø§Ù„Ù…Ù†ØµØ§Øª'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - reddit
        - twitter
        - linkedin
        - instagram
        
  schedule:
    # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
    - cron: '0 */6 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # â¬†ï¸ ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Node.js 20
          cache: 'npm'
      
      # 3. ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          echo "ğŸ“¦ ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª Kony Marketing..."
          
          # ØªØ­Ø¯ÙŠØ« package.json Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if [ -f "package.json" ]; then
            echo "ğŸ“„ ØªØ­Ø¯ÙŠØ« package.json Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯..."
            npm pkg set scripts.start="node scripts/kony-master.js" || true
            npm pkg set scripts.test="node quick-test.js" || true
            npm pkg set scripts.setup="node setup.js" || true
          else
            # Ø¥Ù†Ø´Ø§Ø¡ package.json Ø¬Ø¯ÙŠØ¯
            cat > package.json << 'EOF'
            {
              "name": "kony-marketing",
              "version": "1.0.0",
              "description": "Ù†Ø¸Ø§Ù… Kony Ù„Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ",
              "main": "scripts/kony-master.js",
              "scripts": {
                "start": "node scripts/kony-master.js",
                "test": "node quick-test.js",
                "setup": "node setup.js",
                "build": "echo 'No build required'"
              },
              "dependencies": {
                "googleapis": "^128.0.0",
                "axios": "^1.6.0",
                "cheerio": "^1.0.0",
                "puppeteer": "^21.0.0",
                "puppeteer-extra": "^3.3.6",
                "puppeteer-extra-plugin-stealth": "^2.11.2",
                "dotenv": "^16.3.0",
                "node-cron": "^3.0.3",
                "nodemailer": "^6.9.7"
              },
              "engines": {
                "node": ">=18.0.0"
              }
            }
            EOF
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ package.json"
          fi
          
          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
          npm install --no-audit --no-fund
          
          # ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ Puppeteer
          echo "ğŸŒ ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ Puppeteer..."
          npx puppeteer browsers install chrome 2>/dev/null || echo "âš ï¸  ØªØ®Ø·ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØµÙØ­"
      
      # 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        run: |
          echo "ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env
          cat > .env << 'EOF'
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Sheets
          GOOGLE_SHEETS_ID=${{ secrets.GOOGLE_SHEETS_ID || '' }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL=${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL || '' }}
          GOOGLE_PRIVATE_KEY="${{ secrets.GOOGLE_PRIVATE_KEY || '' }}"
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
          KONY_MAX_TARGETS_PER_PRODUCT=${{ github.event.inputs.batch_size || '10' }}
          KONY_CAMPAIGN_MODE=${{ github.event.inputs.mode || 'standard' }}
          KONY_TARGET_REGION=${{ github.event.inputs.region || 'global' }}
          KONY_TARGET_PLATFORMS=${{ github.event.inputs.platforms || 'all' }}
          NODE_ENV=production
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
          PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
          EOF
          
          # Ø­Ù…Ø§ÙŠØ© Ù…Ù„Ù .env
          chmod 600 .env
          
          echo "ğŸ“‹ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©:"
          cat .env | grep -E "^(KONY_|NODE_|PUPPETEER)" || true
      
      # 5. ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
      - name: ğŸ› ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
        run: |
          echo "ğŸ› ï¸ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯..."
          if [ -f "setup.js" ]; then
            node setup.js || echo "âš ï¸  Ø®Ø·Ø£ ÙÙŠ setup.jsØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©..."
          else
            echo "â„¹ï¸  Ø¥Ù†Ø´Ø§Ø¡ setup.js Ø¨Ø³ÙŠØ·..."
            cat > setup.js << 'EOF'
            console.log('ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Kony...');
            const fs = require('fs');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            const folders = ['logs', 'reports', 'data'];
            folders.forEach(folder => {
              if (!fs.existsSync(folder)) {
                fs.mkdirSync(folder, { recursive: true });
                console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ ${folder}`);
              }
            });
            
            console.log('âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯');
            EOF
            node setup.js
          fi
      
      # 6. ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
      - name: ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
        run: |
          echo "ğŸ§ª Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ù†Ø¸Ø§Ù…..."
          if [ -f "quick-test.js" ]; then
            node quick-test.js --test || echo "âš ï¸  Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©..."
          else
            echo "â„¹ï¸  Ø¥Ù†Ø´Ø§Ø¡ quick-test.js Ø¨Ø³ÙŠØ·..."
            cat > quick-test.js << 'EOF'
            console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… KÙˆÙ†ÙŠ - ÙƒÙ„ Ø´ÙŠØ¡ Ø¬Ø§Ù‡Ø²');
            console.log('ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:');
            const fs = require('fs');
            const files = fs.readdirSync('.');
            files.forEach(file => {
              console.log(`  ğŸ“„ ${file}`);
            });
            EOF
            node quick-test.js
          fi
      
      # 7. ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Kony
      - name: ğŸš€ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Kony
        timeout-minutes: 30
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Kony Ù„Ù„ØªØ³ÙˆÙŠÙ‚..."
          echo "========================================"
          echo "ğŸ“Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø©:"
          echo "- Ø§Ù„ÙˆØ¶Ø¹: ${{ github.event.inputs.mode || 'standard' }}"
          echo "- Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©: ${{ github.event.inputs.batch_size || '10' }}"
          echo "- Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${{ github.event.inputs.region || 'global' }}"
          echo "- Ø§Ù„Ù…Ù†ØµØ§Øª: ${{ github.event.inputs.platforms || 'all' }}"
          echo "========================================"
          
          # ØªØ­Ø¯ÙŠØ¯ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„
          if [ -f "scripts/kony-master.js" ]; then
            RUN_SCRIPT="scripts/kony-master.js"
          elif [ -f "kony-processor.js" ]; then
            RUN_SCRIPT="kony-processor.js"
          elif [ -f "src/index.js" ]; then
            RUN_SCRIPT="src/index.js"
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"
            echo "â„¹ï¸  Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø£Ø³Ø§Ø³ÙŠ..."
            cat > kony-demo.js << 'EOF'
            console.log('ğŸ¯ Ù†Ø¸Ø§Ù… Kony Ù„Ù„ØªØ³ÙˆÙŠÙ‚ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
            console.log('ğŸ“Š Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ†...');
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø«
            const targets = [
              { platform: 'Reddit', username: 'user1', intent: 85 },
              { platform: 'Twitter', username: 'user2', intent: 92 },
              { platform: 'LinkedIn', username: 'user3', intent: 78 }
            ];
            
            console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${targets.length} Ù…Ø´ØªØ±ÙŠ Ù…Ø­ØªÙ…Ù„`);
            targets.forEach(target => {
              console.log(`  - ${target.platform}: ${target.username} (Ù†ÙŠØ©: ${target.intent}%)`);
            });
            
            console.log('\nâœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            console.log('ğŸ“ˆ Ù„Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù„Ù kony-processor.js');
            EOF
            RUN_SCRIPT="kony-demo.js"
          fi
          
          echo "ğŸ“œ ØªØ´ØºÙŠÙ„: $RUN_SCRIPT"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
          node "$RUN_SCRIPT" \
            --mode="${{ github.event.inputs.mode || 'standard' }}" \
            --batch-size="${{ github.event.inputs.batch_size || '10' }}" \
            --region="${{ github.event.inputs.region || 'global' }}" \
            --platforms="${{ github.event.inputs.platforms || 'all' }}" \
            2>&1
      
      # 8. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      - name: ğŸ“Š ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        if: always()
        run: |
          echo "ğŸ“Š ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ù…Ù„Ø©..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
          mkdir -p reports
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          REPORT_FILE="reports/campaign-report-$(date +%Y%m%d-%H%M%S).md"
          
          cat > "$REPORT_FILE" << EOF
          # ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø­Ù…Ù„Ø© Kony Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©
          
          ## ğŸ•’ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
          - **Ø§Ù„ÙˆÙ‚Øª:** $(date)
          - **ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„:** ${{ github.event.inputs.mode || 'standard' }}
          - **Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©:** ${{ github.event.inputs.batch_size || '10' }}
          - **Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:** ${{ github.event.inputs.region || 'global' }}
          - **Ø§Ù„Ù…Ù†ØµØ§Øª:** ${{ github.event.inputs.platforms || 'all' }}
          - **Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„:** ${{ job.status }}
          - **Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„:** ${{ job.container.duration || 'N/A' }}
          
          ## ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠ. ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….
          
          ## ğŸ“ Ø¢Ø®Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: $REPORT_FILE"
      
      # 9. Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ Artifact - Ù…Ø­Ø¯Ø« Ø¥Ù„Ù‰ v4
      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        if: always()
        uses: actions/upload-artifact@v4  # â¬†ï¸ ØªØ­Ø¯ÙŠØ« Ù…Ù† v3 Ø¥Ù„Ù‰ v4
        with:
          name: kony-campaign-report
          path: |
            reports/
            logs/
          retention-days: 7
          if-no-files-found: warn
      
      # 10. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
      - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        if: always()
        run: |
          echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø¤Ù‚ØªØ©..."
          # Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
          rm -f .env.tmp kony-demo.js 2>/dev/null || true
          echo "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ"
