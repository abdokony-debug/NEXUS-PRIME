name: WAHAB AI Registration System
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'intelligent'
        type: choice
        options:
          - intelligent
          - fast
          - stealth
      batch_size:
        description: 'Number of platforms to process'
        required: true
        default: '3'
        type: string
      learning_enabled:
        description: 'Enable AI learning'
        required: true
        default: 'true'
        type: boolean

jobs:
  intelligent-registration:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            ca-certificates

      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
          {
            "name": "wahab-ai-system",
            "version": "2.0.0",
            "main": "src/index.js",
            "dependencies": {
              "playwright": "^1.40.0",
              "googleapis": "^128.0.0"
            },
            "scripts": {
              "start": "node src/index.js"
            }
          }
          EOF
          
          echo "üì¶ package.json created"

      - name: Install Node dependencies
        run: |
          npm install
          npx playwright install chromium
          echo "‚úÖ Dependencies installed"

      - name: Create directories
        run: |
          mkdir -p results screenshots
          echo "üìÅ Directories created"

      - name: Load previous knowledge
        if: github.event.inputs.learning_enabled == 'true'
        run: |
          if [ -f "knowledge.json" ]; then
            echo "üß† Loading previous AI knowledge..."
            cp knowledge.json results/knowledge-backup.json 2>/dev/null || true
          else
            echo "üß† Starting fresh AI learning..."
          fi

      - name: Run AI Registration System
        run: |
          echo "üöÄ Starting WAHAB AI Registration System"
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Batch size: ${{ github.event.inputs.batch_size }}"
          echo "AI Learning: ${{ github.event.inputs.learning_enabled }}"
          echo ""
          echo "ü§ñ Features:"
          echo "   ‚Ä¢ Intelligent page analysis"
          echo "   ‚Ä¢ Adaptive registration strategies"
          echo "   ‚Ä¢ Self-learning from successes/failures"
          echo "   ‚Ä¢ Human-like behavior simulation"
          echo "   ‚Ä¢ Knowledge persistence"
          echo ""
          
          node src/index.js \
            --mode ${{ github.event.inputs.mode }} \
            --batch-size ${{ github.event.inputs.batch_size }}
        env:
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          NODE_ENV: production
          AI_MODE: ${{ github.event.inputs.mode }}
          LEARNING_ENABLED: ${{ github.event.inputs.learning_enabled }}
          HUMAN_DELAYS: 'true'
          MAX_RETRIES: '2'

      - name: Save AI knowledge
        if: github.event.inputs.learning_enabled == 'true'
        run: |
          if [ -f "knowledge.json" ]; then
            echo "üíæ Saving AI knowledge for next run..."
            cp knowledge.json results/knowledge-saved-$(date +%s).json
          fi

      - name: Generate AI insights report
        if: always()
        run: |
          echo "üìä AI SYSTEM INSIGHTS REPORT" > ai-insights.md
          echo "============================" >> ai-insights.md
          echo "" >> ai-insights.md
          echo "**Run Details**" >> ai-insights.md
          echo "- Date: $(date)" >> ai-insights.md
          echo "- Mode: ${{ github.event.inputs.mode }}" >> ai-insights.md
          echo "- Batch Size: ${{ github.event.inputs.batch_size }}" >> ai-insights.md
          echo "- Learning Enabled: ${{ github.event.inputs.learning_enabled }}" >> ai-insights.md
          echo "" >> ai-insights.md
          
          if [ -f "knowledge.json" ]; then
            echo "**Knowledge Base**" >> ai-insights.md
            echo '```json' >> ai-insights.md
            cat knowledge.json >> ai-insights.md
            echo '```' >> ai-insights.md
          fi
          
          if ls results/report-*.json 1> /dev/null 2>&1; then
            latest_report=$(ls -t results/report-*.json | head -1)
            echo "" >> ai-insights.md
            echo "**Latest Run Summary**" >> ai-insights.md
            cat $latest_report | python3 -c "
import json,sys
data=json.load(sys.stdin)
print(f'- Platforms Processed: {data[\"platformsProcessed\"]}')
print(f'- Total Accounts Requested: {data[\"summary\"][\"totalRequested\"]}')
print(f'- Total Accounts Created: {data[\"summary\"][\"totalCreated\"]}')
print(f'- Success Rate: {data[\"summary\"][\"successRate\"]}%')
print('')
print('**Platform Details:**')
for platform in data['results']:
    print(f'- {platform[\"platform\"]}: {platform[\"accountsCreated\"]}/{platform[\"accountsCreated\"]+platform[\"accountsFailed\"]} ({platform[\"message\"]})')
" >> ai-insights.md
          fi
          
          cat ai-insights.md

      - name: Upload results and knowledge
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-ai-results-${{ github.run_id }}
          path: |
            results/
            knowledge.json
            ai-insights.md
          retention-days: 30

      - name: Post-run analysis
        if: always()
        run: |
          echo "üìà POST-RUN ANALYSIS"
          echo "==================="
          echo ""
          echo "üîç Check the following:"
          echo "   1. Google Sheet for registration results"
          echo "   2. Downloaded artifacts for detailed reports"
          echo "   3. AI knowledge file for learning progress"
          echo ""
          echo "üß† Next run will be smarter!"
          echo ""
          echo "üìä View Google Sheet:"
          echo "https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
