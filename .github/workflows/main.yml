name: WAHAB Referral System
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'platforms'
        type: choice
        options:
          - platforms
          - users
      batch_size:
        description: 'Number of items to process'
        required: true
        default: '5'
        type: string

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Ø§Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ø© Docker Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù€ Playwright
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-focal
      options: --user root
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node dependencies
        run: |
          # ØªØ­Ø¯ÙŠØ« npm ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          npm init -y
          npm install googleapis
          # Playwright Ù…Ø«Ø¨Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
          echo "âœ… Dependencies installed"

      - name: Verify environment
        run: |
          echo "ðŸ” Environment check:"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Playwright version: $(npx playwright --version)"
          
          # Ø§Ø®ØªØ¨Ø§Ø± Playwright
          node -e "
          const { chromium } = require('playwright');
          (async () => {
            console.log('ðŸ§ª Testing Playwright...');
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            await page.goto('https://example.com');
            const title = await page.title();
            console.log('âœ… Playwright is working! Title:', title);
            await browser.close();
          })();
          "

      - name: Run WAHAB System
        run: |
          echo "ðŸš€ Starting WAHAB System with mode: ${{ github.event.inputs.mode }}"
          echo "ðŸ“¦ Batch size: ${{ github.event.inputs.batch_size }}"
          echo ""
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
          node src/index.js --mode ${{ github.event.inputs.mode }} --batch-size ${{ github.event.inputs.batch_size }}
        env:
          # ðŸ” Google Authentication
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          
          # âš™ï¸ System Settings
          NODE_ENV: production
          OPERATION_MODE: fast
          MAX_PLATFORMS: ${{ github.event.inputs.batch_size }}
          DELAY_BETWEEN_ACTIONS: 2000
          SAVE_SCREENSHOTS: false

      - name: Create summary report
        if: always()
        run: |
          echo "# WAHAB System Run Report" > report.md
          echo "## Run Details" >> report.md
          echo "- **Time:** $(date)" >> report.md
          echo "- **Mode:** ${{ github.event.inputs.mode }}" >> report.md
          echo "- **Batch Size:** ${{ github.event.inputs.batch_size }}" >> report.md
          echo "- **Status:** ${{ job.status }}" >> report.md
          echo "" >> report.md
          echo "## Google Sheets Info" >> report.md
          echo "- **Sheet ID:** ${{ secrets.GOOGLE_SHEET_ID }}" >> report.md
          echo "- **Service Account:** ${{ secrets.GOOGLE_CLIENT_EMAIL }}" >> report.md
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù„Ù log
          if [ -f "wahab-system.log" ]; then
            echo "" >> report.md
            echo "## Last 10 Log Lines" >> report.md
            echo '```' >> report.md
            tail -10 wahab-system.log >> report.md
            echo '```' >> report.md
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-report-${{ github.run_id }}
          path: |
            report.md
            *.log
            *.json
          retention-days: 7

      - name: Post-run reminder
        if: always()
        run: |
          echo "ðŸ“‹ IMPORTANT REMINDER:" 
          echo "======================"
          echo ""
          echo "To fix the 'permission' error in Google Sheets:"
          echo ""
          echo "1. Open your Google Sheet:"
          echo "   https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo ""
          echo "2. Click 'Share' button"
          echo ""
          echo "3. Add this email address:"
          echo "   ${{ secrets.GOOGLE_CLIENT_EMAIL }}"
          echo ""
          echo "4. Set permission to 'Editor' (not 'Viewer')"
          echo ""
          echo "5. Click 'Send'"
          echo ""
          echo "6. Re-run this workflow"
          echo ""
          echo "ðŸ”— Sheet sharing link:"
          echo "https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit#gid=0"
