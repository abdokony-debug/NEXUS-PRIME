name: WAHAB AI Registration System
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'intelligent'
        type: choice
        options:
          - intelligent
          - fast
          - stealth
      batch_size:
        description: 'Number of platforms to process'
        required: true
        default: '3'
        type: string
      learning_enabled:
        description: 'Enable AI learning'
        required: true
        default: 'true'
        type: boolean

jobs:
  intelligent-registration:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            ca-certificates \
            jq  # Ù„Ù€ JSON config Ø¢Ù…Ù†[web:23]

      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
{
  "name": "wahab-ai-system",
  "version": "2.1.0",
  "main": "src/index.js",
  "dependencies": {
    "playwright": "^1.48.0",
    "googleapis": "^128.0.0",
    "axios": "^1.8.0"
  },
  "scripts": {
    "start": "node src/index.js"
  }
}
EOF
          echo "ğŸ“¦ package.json created (Ù…Ø¹ axios + playwright Ø­Ø¯ÙŠØ«)"

      - name: Install Node dependencies
        run: |
          npm install
          npx playwright install --with-deps chromium  # deps Ù…Ø¯Ù…Ø¬Ø©[web:18][web:26]
          echo "âœ… Dependencies + Chromium installed"

      - name: Create directories
        run: |
          mkdir -p results screenshots logs src /tmp/google-auth
          echo "ğŸ“ Directories created"

      - name: Load previous knowledge
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ§  Loading previous AI knowledge..."
            cp knowledge.json results/knowledge-backup.json 2>/dev/null || true
          else
            echo "ğŸ§  Starting fresh AI learning..."
          fi

      - name: Setup Google Service Account (Multiline Safe)
        env:
          GOOGLE_PRIVATE_KEY_B64: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        run: |
          # Decode multiline private key[web:28][web:33]
          echo "$GOOGLE_PRIVATE_KEY_B64" | base64 -d > /tmp/google-auth/key.json
          echo "/tmp/google-auth/key.json created for googleapis"
        shell: bash

      - name: Create configuration file (JSON Safe)
        env:
          MODE: ${{ github.event.inputs.mode }}
          BATCH: ${{ github.event.inputs.batch_size }}
          LEARNING: ${{ github.event.inputs.learning_enabled }}
          RUN_ID: ${{ github.run_id }}
        run: |
          jq -n \
            --arg mode "$MODE" \
            --argjson batch "$BATCH" \
            --argjson learning "$LEARNING" \
            --arg runId "$RUN_ID" \
            '{
              aiSystem: {
                version: "2.1.0",
                mode: $mode,
                batchSize: $batch,
                learningEnabled: $learning,
                enableScreenshots: false,
                targetPlatforms: "",
                runType: "manual",
                runId: $runId
              },
              settings: {
                maxRetries: 3,
                timeout: 300000,
                humanLikeDelays: true,
                minDelay: 1000,
                maxDelay: 5000,
                headless: true,
                googleKeyFile: "/tmp/google-auth/key.json"
              }
            }' > config.json
          
          echo "âš™ï¸ Configuration created (JSON valid)"
          cat config.json

      - name: Run AI Registration System
        run: |
          echo "ğŸš€ Starting WAHAB AI Registration System"
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Batch size: ${{ github.event.inputs.batch_size }}"
          echo "AI Learning: ${{ github.event.inputs.learning_enabled }}"
          
          export AI_MODE="${{ github.event.inputs.mode }}"
          export AI_BATCH_SIZE="${{ github.event.inputs.batch_size }}"
          export AI_LEARNING_ENABLED="${{ github.event.inputs.learning_enabled }}"
          export HUMAN_DELAYS=true
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/google-auth/key.json"
          
          node src/index.js
        env:
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          NODE_ENV: production

      - name: Save AI knowledge
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ’¾ Saving AI knowledge..."
            cp knowledge.json results/knowledge-saved-$(date +%s).json
          fi

      - name: Generate summary report
        if: always()
        run: |
          echo "# WAHAB AI System Report" > summary.md
          echo "" >> summary.md
          echo "## Run Information" >> summary.md
          echo "- **Date:** $(date)" >> summary.md
          echo "- **Trigger:** Manual" >> summary.md
          echo "- **Status:** ${{ job.status }}" >> summary.md
          echo "" >> summary.md
          echo "- **Mode:** ${{ github.event.inputs.mode }}" >> summary.md
          echo "- **Batch Size:** ${{ github.event.inputs.batch_size }}" >> summary.md
          echo "- **Learning:** ${{ github.event.inputs.learning_enabled }}" >> summary.md
          
          if ls results/report-*.json 1> /dev/null 2>&1; then
            latest_report=$(ls -t results/report-*.json | head -1)
            echo "" >> summary.md
            echo "## Results" >> summary.md
            echo '```json' >> summary.md
            cat "$latest_report" | python3 -c "
import json,sys
data=json.load(sys.stdin)
print(f'Platforms Processed: {data[\"platformsProcessed\"]}')
print(f'Total Accounts Requested: {data[\"summary\"][\"totalRequested\"]}')
print(f'Total Accounts Created: {data[\"summary\"][\"totalCreated\"]}')
print(f'Total Accounts Failed: {data[\"summary\"][\"totalFailed\"]}')
print(f'Success Rate: {data[\"summary\"][\"successRate\"]}%')
" >> summary.md
            echo '```' >> summary.md
          fi
          
          echo "" >> summary.md
          echo "## Google Sheet" >> summary.md
          echo "- **View Results:** https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit" >> summary.md
          
          cat summary.md

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-ai-results-${{ github.run_id }}
          path: |
            results/
            knowledge.json
            summary.md
            screenshots/
            config.json
          retention-days: 30

      - name: Success notification
        if: success()
        run: |
          echo "ğŸ‰ WAHAB AI SYSTEM COMPLETED SUCCESSFULLY!"
          echo ""
          echo "ğŸ“Š View results in Google Sheets:"
          echo "https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo ""
          echo "ğŸ“¦ Download detailed report from artifacts"
          echo ""
          echo "ğŸ” Next run will be smarter!"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ WAHAB AI SYSTEM FAILED!"
          echo ""
          echo "ğŸ”§ Check:"
          echo "1. Google Sheet: Publish to web CSV or service account perms[web:21]"
          echo "2. Secrets: PRIVATE_KEY base64 encoded"
          echo "3. src/index.js logs in artifacts"
          echo ""
          echo "ğŸ“‹ Debug: Download wahab-ai-results artifact"
