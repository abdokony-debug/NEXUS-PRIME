name: WAHAB AI Registration System
on: 
  # âœ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'intelligent'
        type: choice
        options:
          - intelligent
          - fast
          - stealth
          - debug
      batch_size:
        description: 'Number of platforms to process'
        required: true
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
          - '10'
      learning_enabled:
        description: 'Enable AI learning'
        required: true
        default: true
        type: boolean
      enable_screenshots:
        description: 'Take screenshots for debugging'
        required: true
        default: false
        type: boolean
      target_platforms:
        description: 'Specific platforms to target (comma-separated, leave empty for all)'
        required: false
        default: ''
        type: string

  # âœ… ØªØ´ØºÙŠÙ„ Ù…Ø¬Ø¯ÙˆÙ„ (ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª)
  schedule:
    - cron: '0 */6 * * *'

  # âœ… ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  push:
    branches:
      - main

jobs:
  intelligent-registration:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    env:
      GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
      GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
      GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      NODE_ENV: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine run type and parameters
        id: params
        run: |
          echo "ğŸƒ RUN TYPE: ${{ github.event_name }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="${{ github.event.inputs.mode }}"
            BATCH="${{ github.event.inputs.batch_size }}"
            LEARNING="${{ github.event.inputs.learning_enabled }}"
            SCREENSHOTS="${{ github.event.inputs.enable_screenshots }}"
            TARGET_PLATFORMS="${{ github.event.inputs.target_platforms }}"
            echo "ğŸ“ Manual run with custom parameters"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            MODE="intelligent"
            BATCH="3"
            LEARNING="true"
            SCREENSHOTS="false"
            TARGET_PLATFORMS=""
            echo "âš¡ Automatic run (push to main)"
          else
            MODE="fast"
            BATCH="2"
            LEARNING="true"
            SCREENSHOTS="false"
            TARGET_PLATFORMS=""
            echo "â° Scheduled run"
          fi
          
          echo "âœ… Mode: $MODE"
          echo "âœ… Batch size: $BATCH"
          echo "âœ… AI Learning: $LEARNING"
          echo "âœ… Screenshots: $SCREENSHOTS"
          
          # Ø­ÙØ¸ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "batch=$BATCH" >> $GITHUB_OUTPUT
          echo "learning=$LEARNING" >> $GITHUB_OUTPUT
          echo "screenshots=$SCREENSHOTS" >> $GITHUB_OUTPUT
          echo "target_platforms=$TARGET_PLATFORMS" >> $GITHUB_OUTPUT
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
          cat > .run-params << EOF
          MODE=$MODE
          BATCH_SIZE=$BATCH
          LEARNING_ENABLED=$LEARNING
          ENABLE_SCREENSHOTS=$SCREENSHOTS
          TARGET_PLATFORMS=$TARGET_PLATFORMS
          RUN_TYPE=${{ github.event_name }}
          RUN_ID=${{ github.run_id }}
          EOF

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            ca-certificates \
            jq  # Ù„Ø¥Ø¯Ø§Ø±Ø© JSON
          
          echo "âœ… System dependencies installed"

      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
          {
            "name": "wahab-ai-system",
            "version": "2.1.0",
            "description": "WAHAB AI - Advanced Registration System",
            "main": "src/index.js",
            "dependencies": {
              "playwright": "^1.40.0",
              "googleapis": "^128.0.0",
              "dotenv": "^16.3.0",
              "fs-extra": "^11.1.1"
            },
            "scripts": {
              "start": "node src/index.js",
              "test": "echo \"No tests specified\" && exit 0"
            },
            "keywords": ["ai", "automation", "registration"],
            "author": "WAHAB AI System",
            "license": "MIT"
          }
          EOF
          
          echo "ğŸ“¦ package.json created successfully"

      - name: Install Node dependencies
        run: |
          npm ci --no-audit --progress=false
          npx playwright install chromium --with-deps
          echo "âœ… Node.js dependencies installed"

      - name: Create directory structure
        run: |
          mkdir -p results screenshots logs src
          echo "ğŸ“ Directory structure created"

      - name: Load previous AI knowledge
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ§  Loading previous AI knowledge..."
            cp knowledge.json results/knowledge-backup-$(date +%s).json 2>/dev/null || true
            echo "âœ… Knowledge loaded from previous run"
          else
            echo "ğŸ§  Starting fresh AI learning session..."
            echo '{"platforms": {}, "successPatterns": [], "failurePatterns": []}' > knowledge.json
          fi

      - name: Create configuration file
        run: |
          cat > config.json << EOF
          {
            "aiSystem": {
              "version": "2.1.0",
              "mode": "${{ steps.params.outputs.mode }}",
              "batchSize": ${{ steps.params.outputs.batch }},
              "learningEnabled": ${{ steps.params.outputs.learning }},
              "enableScreenshots": ${{ steps.params.outputs.screenshots }},
              "targetPlatforms": "${{ steps.params.outputs.target_platforms }}",
              "runType": "${{ github.event_name }}",
              "runId": "${{ github.run_id }}"
            },
            "settings": {
              "maxRetries": 3,
              "timeout": 300000,
              "humanLikeDelays": true,
              "minDelay": 1000,
              "maxDelay": 5000,
              "headless": true
            }
          }
          EOF
          
          echo "âš™ï¸ Configuration created:"
          cat config.json

      - name: Create dummy AI script (if not exists)
        run: |
          if [ ! -f "src/index.js" ]; then
            echo "ğŸ“ Creating dummy AI script for testing..."
            mkdir -p src
            cat > src/index.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          console.log('ğŸš€ WAHAB AI Registration System v2.1.0');
          console.log('=======================================');
          
          // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          const config = JSON.parse(fs.readFileSync('config.json', 'utf8'));
          console.log('Configuration:', JSON.stringify(config, null, 2));
          
          // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…
          const platforms = ['Facebook', 'Twitter', 'Instagram', 'LinkedIn', 'Github'];
          const batchSize = Math.min(config.aiSystem.batchSize, platforms.length);
          
          console.log(`\nğŸ¯ Processing ${batchSize} platforms in ${config.aiSystem.mode} mode`);
          
          // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          const results = [];
          for (let i = 0; i < batchSize; i++) {
            const platform = platforms[i];
            const success = Math.random() > 0.3;
            
            results.push({
              platform,
              status: success ? 'SUCCESS' : 'FAILED',
              account: success ? `user${Date.now()}${i}@example.com` : null,
              timestamp: new Date().toISOString(),
              details: success ? 'Account created successfully' : 'Simulated failure'
            });
            
            console.log(`  ${success ? 'âœ…' : 'âŒ'} ${platform}: ${success ? 'Created' : 'Failed'}`);
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø´Ø±ÙŠ
            if (config.settings.humanLikeDelays) {
              const delay = Math.floor(Math.random() * 
                (config.settings.maxDelay - config.settings.minDelay)) + config.settings.minDelay;
              await new Promise(resolve => setTimeout(resolve, delay));
            }
          }
          
          // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          const report = {
            timestamp: new Date().toISOString(),
            runId: config.aiSystem.runId,
            mode: config.aiSystem.mode,
            platformsProcessed: batchSize,
            results: results,
            summary: {
              totalRequested: batchSize,
              totalCreated: results.filter(r => r.status === 'SUCCESS').length,
              totalFailed: results.filter(r => r.status === 'FAILED').length,
              successRate: Math.round((results.filter(r => r.status === 'SUCCESS').length / batchSize) * 100)
            }
          };
          
          // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          const reportFile = `results/report-${Date.now()}.json`;
          fs.writeFileSync(reportFile, JSON.stringify(report, null, 2));
          
          // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          const knowledgeFile = 'knowledge.json';
          let knowledge = { platforms: {}, successPatterns: [], failurePatterns: [] };
          
          if (fs.existsSync(knowledgeFile)) {
            knowledge = JSON.parse(fs.readFileSync(knowledgeFile, 'utf8'));
          }
          
          results.forEach(result => {
            if (!knowledge.platforms[result.platform]) {
              knowledge.platforms[result.platform] = { attempts: 0, successes: 0, failures: 0 };
            }
            
            knowledge.platforms[result.platform].attempts++;
            if (result.status === 'SUCCESS') {
              knowledge.platforms[result.platform].successes++;
              knowledge.successPatterns.push({
                platform: result.platform,
                timestamp: result.timestamp,
                mode: config.aiSystem.mode
              });
            } else {
              knowledge.platforms[result.platform].failures++;
              knowledge.failurePatterns.push({
                platform: result.platform,
                timestamp: result.timestamp,
                mode: config.aiSystem.mode
              });
            }
          });
          
          fs.writeFileSync(knowledgeFile, JSON.stringify(knowledge, null, 2));
          
          console.log('\nğŸ“Š Results Summary:');
          console.log(`   Platforms processed: ${report.summary.totalRequested}`);
          console.log(`   Accounts created: ${report.summary.totalCreated}`);
          console.log(`   Accounts failed: ${report.summary.totalFailed}`);
          console.log(`   Success rate: ${report.summary.successRate}%`);
          console.log('\nğŸ’¾ Reports saved to:');
          console.log(`   - ${reportFile}`);
          console.log(`   - ${knowledgeFile}`);
          console.log('\nğŸ‰ WAHAB AI process completed!');
          
          // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©
          process.exit(report.summary.totalCreated > 0 ? 0 : 1);
          EOF
            echo "âœ… Dummy AI script created for testing"
          else
            echo "âœ… Existing AI script found"
          fi

      - name: Run WAHAB AI Registration System
        run: |
          echo "ğŸš€ Launching WAHAB AI Registration System..."
          echo "============================================"
          
          # ØªØµØ¯ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
          export AI_MODE=${{ steps.params.outputs.mode }}
          export AI_BATCH_SIZE=${{ steps.params.outputs.batch }}
          export AI_LEARNING_ENABLED=${{ steps.params.outputs.learning }}
          export AI_SCREENSHOTS=${{ steps.params.outputs.screenshots }}
          export TARGET_PLATFORMS="${{ steps.params.outputs.target_platforms }}"
          export RUN_TIMESTAMP=$(date +%s)
          
          # ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„
          echo "ğŸ•’ Start time: $(date)"
          echo "ğŸ”§ Mode: $AI_MODE"
          echo "ğŸ“¦ Batch size: $AI_BATCH_SIZE"
          echo "ğŸ§  Learning enabled: $AI_LEARNING_ENABLED"
          echo "ğŸ“¸ Screenshots: $AI_SCREENSHOTS"
          echo "ğŸ¯ Target platforms: $TARGET_PLATFORMS"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
          cd src && node index.js
          
          # ØªØ³Ø¬ÙŠÙ„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„
          echo "ğŸ•’ End time: $(date)"
          echo "============================================"
          echo "âœ… AI System execution completed"

      - name: Save AI knowledge
        if: always()
        run: |
          echo "ğŸ’¾ Saving AI knowledge state..."
          
          if [ -f "knowledge.json" ]; then
            # Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø¤Ø±Ø´ÙØ©
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            cp knowledge.json results/knowledge-$TIMESTAMP.json
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ©
            echo "ğŸ“ˆ AI Knowledge Analysis:"
            if command -v jq &> /dev/null; then
              TOTAL_PLATFORMS=$(jq '.platforms | length' knowledge.json)
              TOTAL_SUCCESS=$(jq '.successPatterns | length' knowledge.json)
              TOTAL_FAILURE=$(jq '.failurePatterns | length' knowledge.json)
              
              echo "   Platforms learned: $TOTAL_PLATFORMS"
              echo "   Success patterns: $TOTAL_SUCCESS"
              echo "   Failure patterns: $TOTAL_FAILURE"
            fi
            
            echo "âœ… Knowledge saved: results/knowledge-$TIMESTAMP.json"
          else
            echo "âš ï¸ No knowledge.json file found"
          fi

      - name: Generate comprehensive report
        if: always()
        run: |
          echo "ğŸ“Š Generating system report..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          cat > SYSTEM_REPORT.md << EOF
          # WAHAB AI Registration System - Run Report
          
          ## Run Information
          - **Run ID:** ${{ github.run_id }}
          - **Run Number:** ${{ github.run_number }}
          - **Trigger:** ${{ github.event_name }}
          - **Status:** ${{ job.status }}
          - **Start Time:** $(date -d @$RUN_TIMESTAMP 2>/dev/null || echo "N/A")
          - **Duration:** N/A
          
          ## Configuration
          - **Mode:** ${{ steps.params.outputs.mode }}
          - **Batch Size:** ${{ steps.params.outputs.batch }}
          - **AI Learning:** ${{ steps.params.outputs.learning }}
          - **Screenshots:** ${{ steps.params.outputs.screenshots }}
          - **Target Platforms:** ${{ steps.params.outputs.target_platforms }}
          
          ## Results Summary
          EOF
          
          # Ø¥Ø¶Ø§ÙØ© Ù†ØªØ§Ø¦Ø¬ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
          if ls results/report-*.json 1> /dev/null 2>&1; then
            LATEST_REPORT=$(ls -t results/report-*.json | head -1)
            
            echo "\n## Latest Run Results" >> SYSTEM_REPORT.md
            echo '```json' >> SYSTEM_REPORT.md
            cat $LATEST_REPORT | jq '.' >> SYSTEM_REPORT.md 2>/dev/null || cat $LATEST_REPORT >> SYSTEM_REPORT.md
            echo '```' >> SYSTEM_REPORT.md
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          if [ -f "knowledge.json" ]; then
            echo "\n## AI Knowledge Summary" >> SYSTEM_REPORT.md
            echo "The AI system has learned from previous runs." >> SYSTEM_REPORT.md
            
            if command -v jq &> /dev/null; then
              echo "\n### Platform Statistics:" >> SYSTEM_REPORT.md
              echo '```' >> SYSTEM_REPORT.md
              jq -r '.platforms | to_entries[] | "\(.key): \(.value.attempts) attempts, \(.value.successes) successes, \(.value.failures) failures"' knowledge.json >> SYSTEM_REPORT.md
              echo '```' >> SYSTEM_REPORT.md
            fi
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
          echo "\n## System Information" >> SYSTEM_REPORT.md
          echo "- **Runner:** ${{ runner.os }} ${{ runner.arch }}" >> SYSTEM_REPORT.md
          echo "- **Node.js:** $(node --version)" >> SYSTEM_REPORT.md
          echo "- **Playwright:** Available" >> SYSTEM_REPORT.md
          
          # Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø·
          echo "\n## Useful Links" >> SYSTEM_REPORT.md
          echo "- [Google Sheet](https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit)" >> SYSTEM_REPORT.md
          echo "- [GitHub Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> SYSTEM_REPORT.md
          
          cat SYSTEM_REPORT.md
          
          # Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù†ØªØ§Ø¦Ø¬
          cp SYSTEM_REPORT.md results/SYSTEM_REPORT-${{ github.run_id }}.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-ai-run-${{ github.run_id }}
          path: |
            results/
            knowledge.json
            config.json
            SYSTEM_REPORT.md
            screenshots/
            logs/
          retention-days: 90
          compression-level: 9

      - name: Success notification
        if: success()
        run: |
          echo ""
          echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— "
          echo "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—"
          echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
          echo "â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—"
          echo "â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
          echo "â•šâ•â•      â•šâ•â•â•â•šâ•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• "
          echo ""
          echo "ğŸ‰ WAHAB AI SYSTEM COMPLETED SUCCESSFULLY!"
          echo ""
          echo "ğŸ“Š View detailed report in artifacts"
          echo "ğŸ“ˆ Download results from GitHub Actions"
          echo ""
          echo "ğŸ”— Google Sheet: https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo "ğŸ”— Run Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ§  AI knowledge has been updated for next run"
          echo "â° Next scheduled run in 6 hours"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ WAHAB AI SYSTEM ENCOUNTERED AN ERROR!"
          echo ""
          echo "ğŸ”§ Troubleshooting steps:"
          echo "1. Check the workflow logs above"
          echo "2. Verify Google Sheets API credentials"
          echo "3. Check network connectivity"
          echo "4. Review AI knowledge file"
          echo ""
          echo "ğŸ“‹ Artifacts contain debug information"
          echo "ğŸ”„ Retry with debug mode for detailed logs"
          echo ""
          echo "ğŸ’¡ Tip: Run in debug mode with screenshots enabled"
