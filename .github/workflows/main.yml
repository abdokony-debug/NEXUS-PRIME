name: WAHAB AI Registration System
on:
  # âœ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ push Ø¥Ù„Ù‰ main
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/**'
  
  # âœ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'intelligent'
        type: choice
        options:
          - intelligent
          - fast
          - stealth
      batch_size:
        description: 'Number of platforms to process'
        required: true
        default: '3'
        type: string
      learning_enabled:
        description: 'Enable AI learning'
        required: true
        default: 'true'
        type: boolean

  # âœ… ØªØ´ØºÙŠÙ„ Ù…Ø¬Ø¯ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª)
  schedule:
    - cron: '0 */6 * * *'

jobs:
  intelligent-registration:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine run type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸƒ RUN TYPE: Manual"
            echo "MODE: ${{ github.event.inputs.mode }}"
            echo "BATCH: ${{ github.event.inputs.batch_size }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "ğŸƒ RUN TYPE: Automatic (Push to main)"
            echo "MODE: intelligent"
            echo "BATCH: 3"
          else
            echo "ğŸƒ RUN TYPE: Scheduled"
            echo "MODE: fast"
            echo "BATCH: 2"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            ca-certificates

      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
          {
            "name": "wahab-ai-system",
            "version": "2.0.0",
            "main": "src/index.js",
            "dependencies": {
              "playwright": "^1.40.0",
              "googleapis": "^128.0.0"
            },
            "scripts": {
              "start": "node src/index.js"
            }
          }
          EOF
          
          echo "ğŸ“¦ package.json created"

      - name: Install Node dependencies
        run: |
          npm install
          npx playwright install chromium
          echo "âœ… Dependencies installed"

      - name: Create directories
        run: |
          mkdir -p results screenshots
          echo "ğŸ“ Directories created"

      - name: Load previous knowledge
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ§  Loading previous AI knowledge..."
            cp knowledge.json results/knowledge-backup.json 2>/dev/null || true
          else
            echo "ğŸ§  Starting fresh AI learning..."
          fi

      - name: Run AI Registration System
        run: |
          echo "ğŸš€ Starting WAHAB AI Registration System"
          
          # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ØªØ´ØºÙŠÙ„
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="${{ github.event.inputs.mode }}"
            BATCH="${{ github.event.inputs.batch_size }}"
            LEARNING="${{ github.event.inputs.learning_enabled }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            MODE="intelligent"
            BATCH="3"
            LEARNING="true"
          else
            MODE="fast"
            BATCH="2"
            LEARNING="true"
          fi
          
          echo "Mode: $MODE"
          echo "Batch size: $BATCH"
          echo "AI Learning: $LEARNING"
          echo ""
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
          node src/index.js \
            --mode $MODE \
            --batch-size $BATCH
        env:
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          NODE_ENV: production
          AI_MODE: $MODE
          LEARNING_ENABLED: $LEARNING
          HUMAN_DELAYS: 'true'

      - name: Save AI knowledge
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ’¾ Saving AI knowledge for next run..."
            cp knowledge.json results/knowledge-saved-$(date +%s).json
          fi

      - name: Generate summary report
        if: always()
        run: |
          echo "# WAHAB AI System Report" > summary.md
          echo "" >> summary.md
          echo "## Run Information" >> summary.md
          echo "- **Date:** $(date)" >> summary.md
          echo "- **Trigger:** ${{ github.event_name }}" >> summary.md
          echo "- **Status:** ${{ job.status }}" >> summary.md
          echo "" >> summary.md
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "- **Mode:** ${{ github.event.inputs.mode }}" >> summary.md
            echo "- **Batch Size:** ${{ github.event.inputs.batch_size }}" >> summary.md
            echo "- **Learning:** ${{ github.event.inputs.learning_enabled }}" >> summary.md
          fi
          
          if ls results/report-*.json 1> /dev/null 2>&1; then
            latest_report=$(ls -t results/report-*.json | head -1)
            echo "" >> summary.md
            echo "## Results" >> summary.md
            echo '```json' >> summary.md
            cat $latest_report | python3 -c "
import json,sys
data=json.load(sys.stdin)
print(f'Platforms Processed: {data[\"platformsProcessed\"]}')
print(f'Total Accounts Requested: {data[\"summary\"][\"totalRequested\"]}')
print(f'Total Accounts Created: {data[\"summary\"][\"totalCreated\"]}')
print(f'Total Accounts Failed: {data[\"summary\"][\"totalFailed\"]}')
print(f'Success Rate: {data[\"summary\"][\"successRate\"]}%')
" >> summary.md
            echo '```' >> summary.md
          fi
          
          echo "" >> summary.md
          echo "## Google Sheet" >> summary.md
          echo "- **View Results:** https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit" >> summary.md
          
          cat summary.md

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-ai-results-${{ github.run_id }}
          path: |
            results/
            knowledge.json
            summary.md
            screenshots/
          retention-days: 30

      - name: Success notification
        if: success()
        run: |
          echo "ğŸ‰ WAHAB AI SYSTEM COMPLETED SUCCESSFULLY!"
          echo ""
          echo "ğŸ“Š View results in Google Sheets:"
          echo "https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo ""
          echo "ğŸ“¦ Download detailed report from artifacts"
          echo ""
          echo "ğŸ” Next run will be smarter!"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ WAHAB AI SYSTEM FAILED!"
          echo ""
          echo "ğŸ”§ Check the following:"
          echo "1. Google Sheets permissions"
          echo "2. Environment variables"
          echo "3. Playwright installation"
          echo ""
          echo "ğŸ“‹ Debug logs available in artifacts"
