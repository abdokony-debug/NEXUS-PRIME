# .github/workflows/kony-marketing.yml
name: ğŸš€ Kony Marketing System
on: 
  workflow_dispatch:
    inputs:
      mode:
        description: 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - aggressive
        - test
        - research-only
        
      batch_size:
        description: 'Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©'
        required: false
        default: '10'
        type: number
        
      region:
        description: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©'
        required: false
        default: 'global'
        type: choice
        options:
        - global
        - europe
        - usa
        - middle_east
        
      platforms:
        description: 'Ø§Ù„Ù…Ù†ØµØ§Øª'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - reddit
        - twitter
        - linkedin
        - instagram
        
  schedule:
    # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
    - cron: '0 */6 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          echo "ğŸ“¦ ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª Kony Marketing..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ package.json Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if [ ! -f "package.json" ]; then
            cat > package.json << 'EOF'
            {
              "name": "kony-marketing",
              "version": "1.0.0",
              "description": "Ù†Ø¸Ø§Ù… Kony Ù„Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ",
              "main": "scripts/kony-master.js",
              "scripts": {
                "start": "node scripts/kony-master.js",
                "test": "node quick-test.js",
                "setup": "node setup.js"
              },
              "dependencies": {
                "googleapis": "^128.0.0",
                "axios": "^1.6.0",
                "cheerio": "^1.0.0",
                "puppeteer": "^21.0.0",
                "puppeteer-extra": "^3.3.6",
                "puppeteer-extra-plugin-stealth": "^2.11.2",
                "dotenv": "^16.3.0",
                "node-cron": "^3.0.3",
                "nodemailer": "^6.9.7"
              }
            }
            EOF
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ package.json"
          fi
          
          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
          npm install
          
          # ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ Puppeteer
          echo "ğŸŒ ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ Puppeteer..."
          npx puppeteer browsers install chrome
      
      # 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        run: |
          echo "ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©..."
          
          # Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ¦Ø©
          if [ -f "env.example" ]; then
            cp env.example .env
            echo "âœ… ØªÙ… Ù†Ø³Ø® env.example Ø¥Ù„Ù‰ .env"
          else
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env Ø£Ø³Ø§Ø³ÙŠ
            cat > .env << 'EOF'
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Sheets
            GOOGLE_SHEETS_ID=${{ secrets.GOOGLE_SHEETS_ID }}
            GOOGLE_SERVICE_ACCOUNT_EMAIL=${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
            GOOGLE_PRIVATE_KEY="${{ secrets.GOOGLE_PRIVATE_KEY }}"
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            KONY_MAX_TARGETS_PER_PRODUCT=${{ github.event.inputs.batch_size || '10' }}
            KONY_CAMPAIGN_MODE=${{ github.event.inputs.mode || 'standard' }}
            KONY_TARGET_REGION=${{ github.event.inputs.region || 'global' }}
            KONY_TARGET_PLATFORMS=${{ github.event.inputs.platforms || 'all' }}
            NODE_ENV=production
            EOF
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env"
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† secrets
          echo "ğŸ” Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©..."
          echo "GOOGLE_SHEETS_ID=${{ secrets.GOOGLE_SHEETS_ID }}" >> .env
          echo "GOOGLE_SERVICE_ACCOUNT_EMAIL=${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}" >> .env
          echo 'GOOGLE_PRIVATE_KEY="${{ secrets.GOOGLE_PRIVATE_KEY }}"' >> .env
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
          echo "KONY_CAMPAIGN_MODE=${{ github.event.inputs.mode || 'standard' }}" >> .env
          echo "KONY_BATCH_SIZE=${{ github.event.inputs.batch_size || '10' }}" >> .env
          echo "KONY_TARGET_REGION=${{ github.event.inputs.region || 'global' }}" >> .env
          echo "KONY_PLATFORMS=${{ github.event.inputs.platforms || 'all' }}" >> .env
          
          # Ø­Ù…Ø§ÙŠØ© Ù…Ù„Ù .env
          chmod 600 .env
          
          echo "ğŸ“‹ Ù…Ø­ØªÙˆÙ‰ .env (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø³Ø§Ø³Ø©):"
          grep -v "PRIVATE_KEY\|CLIENT_EMAIL" .env || true
      
      # 5. ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
      - name: ğŸ› ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
        run: |
          echo "ğŸ› ï¸ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯..."
          if [ -f "setup.js" ]; then
            node setup.js
          else
            echo "âš ï¸  Ù…Ù„Ù setup.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ®Ø·ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯"
          fi
      
      # 6. ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
      - name: ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
        run: |
          echo "ğŸ§ª Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ù†Ø¸Ø§Ù…..."
          if [ -f "quick-test.js" ]; then
            node quick-test.js --test
          else
            echo "âœ… ØªØ®Ø·ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi
      
      # 7. ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Kony
      - name: ğŸš€ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Kony
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Kony Ù„Ù„ØªØ³ÙˆÙŠÙ‚..."
          echo "========================================"
          echo "ğŸ“Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø©:"
          echo "- Ø§Ù„ÙˆØ¶Ø¹: ${{ github.event.inputs.mode || 'standard' }}"
          echo "- Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©: ${{ github.event.inputs.batch_size || '10' }}"
          echo "- Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${{ github.event.inputs.region || 'global' }}"
          echo "- Ø§Ù„Ù…Ù†ØµØ§Øª: ${{ github.event.inputs.platforms || 'all' }}"
          echo "========================================"
          
          # ØªØ­Ø¯ÙŠØ¯ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„
          if [ -f "scripts/kony-master.js" ]; then
            RUN_SCRIPT="scripts/kony-master.js"
          elif [ -f "kony-processor.js" ]; then
            RUN_SCRIPT="kony-processor.js"
          elif [ -f "src/index.js" ]; then
            RUN_SCRIPT="src/index.js"
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"
            exit 1
          fi
          
          echo "ğŸ“œ ØªØ´ØºÙŠÙ„: $RUN_SCRIPT"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
          node "$RUN_SCRIPT" \
            --mode="${{ github.event.inputs.mode || 'standard' }}" \
            --batch-size="${{ github.event.inputs.batch_size || '10' }}" \
            --region="${{ github.event.inputs.region || 'global' }}" \
            --platforms="${{ github.event.inputs.platforms || 'all' }}"
        
        env:
          NODE_ENV: production
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      
      # 8. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      - name: ğŸ“Š ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        if: always()
        run: |
          echo "ğŸ“Š ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ù…Ù„Ø©..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
          mkdir -p reports
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          cat > reports/campaign-report-$(date +%Y%m%d-%H%M%S).md << 'EOF'
          # ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø­Ù…Ù„Ø© Kony Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©
          
          ## ğŸ•’ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
          - **Ø§Ù„ÙˆÙ‚Øª:** $(date)
          - **ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„:** ${{ github.event.inputs.mode || 'standard' }}
          - **Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©:** ${{ github.event.inputs.batch_size || '10' }}
          - **Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:** ${{ github.event.inputs.region || 'global' }}
          - **Ø§Ù„Ù…Ù†ØµØ§Øª:** ${{ github.event.inputs.platforms || 'all' }}
          - **Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„:** ${{ job.status }}
          
          ## ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          > Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
          
          ## ğŸ“ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
          ```bash
          # Ø¢Ø®Ø± 50 Ø³Ø·Ø±Ø§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
          EOF
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
          if [ -f "logs/kony.log" ]; then
            tail -50 logs/kony.log >> reports/campaign-report-$(date +%Y%m%d-%H%M%S).md
          fi
          
          echo "```" >> reports/campaign-report-$(date +%Y%m%d-%H%M%S).md
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
      
      # 9. Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ Artifact
      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: kony-campaign-report
          path: |
            reports/
            logs/
          retention-days: 7
      
      # 10. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
      - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        if: always()
        run: |
          echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø¤Ù‚ØªØ©..."
          # Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ¨Ù‚ÙŠØ©
          pkill -f "node.*kony" || true
          pkill -f "chrome.*puppeteer" || true
          
          # Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
          rm -f .env.tmp
          
          echo "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ"
  
  # job Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­/Ø§Ù„ÙØ´Ù„
  notify:
    runs-on: ubuntu-latest
    needs: process
    if: always()
    
    steps:
      - name: ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        run: |
          echo "ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø­Ø§Ù„Ø©: ${{ needs.process.result }}"
          
          if [ "${{ needs.process.result }}" = "success" ]; then
            echo "âœ… Ø§Ù„Ø­Ù…Ù„Ø© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
          elif [ "${{ needs.process.result }}" = "failure" ]; then
            echo "âŒ ÙØ´Ù„Øª Ø§Ù„Ø­Ù…Ù„Ø©!"
          else:
            echo "âš ï¸  Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø©: ${{ needs.process.result }}"
          fi
