name: WAHAB AI Registration System
on: 
  # âœ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙÙ‚Ø· Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'intelligent'
        type: choice
        options:
          - intelligent
          - fast
          - stealth
      batch_size:
        description: 'Number of platforms to process'
        required: true
        default: '3'
        type: string
      learning_enabled:
        description: 'Enable AI learning'
        required: true
        default: 'true'
        type: boolean

jobs:
  intelligent-registration:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine parameters
        id: params
        run: |
          echo "ğŸƒ RUN TYPE: Manual"
          echo "MODE: ${{ github.event.inputs.mode }}"
          echo "BATCH: ${{ github.event.inputs.batch_size }}"
          echo "LEARNING: ${{ github.event.inputs.learning_enabled }}"
          
          echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          echo "batch=${{ github.event.inputs.batch_size }}" >> $GITHUB_OUTPUT
          echo "learning=${{ github.event.inputs.learning_enabled }}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            ca-certificates

      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
          {
            "name": "wahab-ai-system",
            "version": "2.0.0",
            "main": "src/index.js",
            "dependencies": {
              "playwright": "^1.40.0",
              "googleapis": "^128.0.0"
            },
            "scripts": {
              "start": "node src/index.js"
            }
          }
          EOF
          
          echo "ğŸ“¦ package.json created"

      - name: Install Node dependencies
        run: |
          npm install
          npx playwright install chromium
          echo "âœ… Dependencies installed"

      - name: Create directories
        run: |
          mkdir -p results screenshots logs src
          echo "ğŸ“ Directories created"

      - name: Load previous knowledge
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ§  Loading previous AI knowledge..."
            cp knowledge.json results/knowledge-backup.json 2>/dev/null || true
          else
            echo "ğŸ§  Starting fresh AI learning..."
          fi

      - name: Create configuration file
        run: |
          cat > config.json << EOF
          {
            "aiSystem": {
              "version": "2.0.0",
              "mode": "${{ steps.params.outputs.mode }}",
              "batchSize": ${{ steps.params.outputs.batch }},
              "learningEnabled": ${{ steps.params.outputs.learning }},
              "enableScreenshots": false,
              "targetPlatforms": "",
              "runType": "manual",
              "runId": "${{ github.run_id }}"
            },
            "settings": {
              "maxRetries": 3,
              "timeout": 300000,
              "humanLikeDelays": true,
              "minDelay": 1000,
              "maxDelay": 5000,
              "headless": true
            }
          }
          EOF
          
          echo "âš™ï¸ Configuration created"
          cat config.json

      - name: Run AI Registration System
        run: |
          echo "ğŸš€ Launching WAHAB AI Registration System..."
          echo "============================================"
          
          # ØªØµØ¯ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
          export AI_MODE="${{ steps.params.outputs.mode }}"
          export AI_BATCH_SIZE="${{ steps.params.outputs.batch }}"
          export AI_LEARNING_ENABLED="${{ steps.params.outputs.learning }}"
          export HUMAN_DELAYS=true
          
          echo "ğŸ•’ Start time: $(date)"
          echo "ğŸ”§ Mode: $AI_MODE"
          echo "ğŸ“¦ Batch size: $AI_BATCH_SIZE"
          echo "ğŸ§  Learning enabled: $AI_LEARNING_ENABLED"
          echo "============================================"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
          node src/index.js
          
          echo "============================================"
          echo "ğŸ•’ End time: $(date)"
          echo "âœ… AI System execution completed"

      - name: Save AI knowledge
        if: always()
        run: |
          if [ -f "knowledge.json" ]; then
            echo "ğŸ’¾ Saving AI knowledge for next run..."
            TIMESTAMP=$(date +%s)
            cp knowledge.json results/knowledge-saved-$TIMESTAMP.json
          fi

      - name: Generate summary report
        if: always()
        run: |
          echo "# WAHAB AI System Report" > summary.md
          echo "" >> summary.md
          echo "## Run Information" >> summary.md
          echo "- **Date:** $(date)" >> summary.md
          echo "- **Trigger:** Manual" >> summary.md
          echo "- **Status:** ${{ job.status }}" >> summary.md
          echo "" >> summary.md
          echo "- **Mode:** ${{ github.event.inputs.mode }}" >> summary.md
          echo "- **Batch Size:** ${{ github.event.inputs.batch_size }}" >> summary.md
          echo "- **Learning:** ${{ github.event.inputs.learning_enabled }}" >> summary.md
          
          if ls results/report-*.json 1> /dev/null 2>&1; then
            latest_report=$(ls -t results/report-*.json | head -1)
            echo "" >> summary.md
            echo "## Results" >> summary.md
            echo '```json' >> summary.md
            cat $latest_report | python3 -c "
import json,sys
data=json.load(sys.stdin)
print(f'Platforms Processed: {data[\"platformsProcessed\"]}')
print(f'Total Accounts Requested: {data[\"summary\"][\"totalRequested\"]}')
print(f'Total Accounts Created: {data[\"summary\"][\"totalCreated\"]}')
print(f'Total Accounts Failed: {data[\"summary\"][\"totalFailed\"]}')
print(f'Success Rate: {data[\"summary\"][\"successRate\"]}%')
" >> summary.md
            echo '```' >> summary.md
          fi
          
          echo "" >> summary.md
          echo "## Google Sheet" >> summary.md
          echo "- **View Results:** https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit" >> summary.md
          
          cat summary.md

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-ai-results-${{ github.run_id }}
          path: |
            results/
            knowledge.json
            summary.md
            screenshots/
            logs/
          retention-days: 30

      - name: Success notification
        if: success()
        run: |
          echo "ğŸ‰ WAHAB AI SYSTEM COMPLETED SUCCESSFULLY!"
          echo ""
          echo "ğŸ“Š View results in Google Sheets:"
          echo "https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo ""
          echo "ğŸ“¦ Download detailed report from artifacts"
          echo ""
          echo "ğŸ” Next run will be smarter!"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ WAHAB AI SYSTEM FAILED!"
          echo ""
          echo "ğŸ”§ Check the following:"
          echo "1. Google Sheets permissions"
          echo "2. Environment variables"
          echo "3. Playwright installation"
          echo ""
          echo "ğŸ“‹ Debug logs available in artifacts"
