name: Run WAHAB System
on: workflow_dispatch

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          echo "Installing required packages..."
          npm install axios@^1.6.0 googleapis@^128.0.0 playwright@^1.40.0 dotenv@^16.3.1
          echo "Packages installed successfully"
      
      - name: Install Playwright with dependencies
        run: |
          echo "Installing Playwright browsers..."
          npx playwright install --with-deps chromium
          echo "Playwright installation completed"
      
      - name: Verify installations
        run: |
          echo "Verifying installed packages..."
          node -e "
            try {
              require('axios');
              console.log('‚úÖ axios is available');
            } catch(e) { console.log('‚ùå axios:', e.message); }
            
            try {
              require('googleapis');
              console.log('‚úÖ googleapis is available');
            } catch(e) { console.log('‚ùå googleapis:', e.message); }
            
            try {
              require('playwright');
              console.log('‚úÖ playwright is available');
            } catch(e) { console.log('‚ùå playwright:', e.message); }
          "
      
      - name: Execute system
        run: |
          echo "Starting WAHAB System..."
          echo "Mode: platforms"
          echo "Batch size: 5"
          echo "Node version: $(node --version)"
          
          # Run the system
          node src/index.js --mode platforms --batch-size 5
          
          echo "‚úÖ System execution completed"
        env:
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          NODE_ENV: production
          PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright
      
      - name: Success notification
        if: success()
        run: echo "üéâ WAHAB System ran successfully!"
