name: WAHAB Referral System
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'platforms'
        type: choice
        options:
          - platforms
          - users
      batch_size:
        description: 'Number of items to process'
        required: true
        default: '5'
        type: string

jobs:
  process:
    runs-on: ubuntu-22.04  # Ø§Ø³ØªØ®Ø¯Ù… Ubuntu 22.04 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies for Playwright
        run: |
          # Ubuntu 22.04 (jammy) dependencies for Playwright
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            ca-certificates

      - name: Install Node.js dependencies
        run: |
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          rm -rf node_modules package-lock.json 2>/dev/null || true
          
          # Ø¥Ù†Ø´Ø§Ø¡ package.json Ø¬Ø¯ÙŠØ¯
          cat > package.json << 'EOF'
          {
            "name": "wahab-system",
            "version": "1.0.0",
            "dependencies": {
              "playwright": "^1.40.0",
              "googleapis": "^128.0.0"
            },
            "scripts": {
              "start": "node src/index.js"
            }
          }
          EOF
          
          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
          npm install
          
          # ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ Playwright
          npx playwright install chromium
          
          echo "âœ… Dependencies installed successfully"

      - name: Verify Playwright installation
        run: |
          echo "ðŸ” Testing Playwright..."
          node -e "
          const { chromium } = require('playwright');
          (async () => {
            console.log('ðŸ§ª Launching browser...');
            const browser = await chromium.launch({ 
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            console.log('âœ… Browser launched successfully');
            await page.goto('https://example.com');
            console.log('âœ… Page loaded successfully');
            await browser.close();
            console.log('ðŸŽ‰ Playwright is working!');
          })().catch(err => {
            console.error('âŒ Playwright error:', err.message);
            process.exit(1);
          });
          "

      - name: Verify Google Sheets permissions
        run: |
          echo "ðŸ” Testing Google Sheets access..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ø®ØªØ¨Ø§Ø±
          cat > test-sheets.js << 'EOF'
          const { google } = require('googleapis');
          
          async function testGoogleSheets() {
            try {
              const auth = new google.auth.GoogleAuth({
                credentials: {
                  client_email: process.env.GOOGLE_CLIENT_EMAIL,
                  private_key: process.env.GOOGLE_PRIVATE_KEY.replace(/\\n/g, '\n')
                },
                scopes: ['https://www.googleapis.com/auth/spreadsheets']
              });
              
              const sheets = google.sheets({ version: 'v4', auth: await auth.getClient() });
              
              // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
              console.log('ðŸ“– Testing read access...');
              const sheetInfo = await sheets.spreadsheets.get({
                spreadsheetId: process.env.GOOGLE_SHEET_ID
              });
              console.log('âœ… Read access OK - Sheet title:', sheetInfo.data.properties.title);
              
              // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
              console.log('âœï¸ Testing write access...');
              try {
                await sheets.spreadsheets.values.update({
                  spreadsheetId: process.env.GOOGLE_SHEET_ID,
                  range: 'TestCell!A1',
                  valueInputOption: 'RAW',
                  resource: { values: [['Test from WAHAB System']] }
                });
                console.log('âœ… Write access OK');
                
                // ØªÙ†Ø¸ÙŠÙ
                await sheets.spreadsheets.values.clear({
                  spreadsheetId: process.env.GOOGLE_SHEET_ID,
                  range: 'TestCell!A1'
                });
                
              } catch (writeError) {
                console.log('âŒ WRITE PERMISSION DENIED');
                console.log('================================');
                console.log('Service Account:', process.env.GOOGLE_CLIENT_EMAIL);
                console.log('Sheet ID:', process.env.GOOGLE_SHEET_ID);
                console.log('');
                console.log('ðŸ”§ ACTION REQUIRED:');
                console.log('1. Open Google Sheet:');
                console.log('   https://docs.google.com/spreadsheets/d/' + process.env.GOOGLE_SHEET_ID + '/edit');
                console.log('2. Click "Share"');
                console.log('3. Add email:', process.env.GOOGLE_CLIENT_EMAIL);
                console.log('4. Set role to "Editor"');
                console.log('5. Click "Send"');
                console.log('');
                console.log('After sharing, re-run this workflow.');
                process.exit(1);
              }
              
            } catch (error) {
              console.error('âŒ Google Sheets error:', error.message);
              process.exit(1);
            }
          }
          
          testGoogleSheets();
          EOF
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
          node test-sheets.js
        env:
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

      - name: Run WAHAB System
        run: |
          echo "ðŸš€ Starting WAHAB System"
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Batch size: ${{ github.event.inputs.batch_size }}"
          echo ""
          
          node src/index.js --mode ${{ github.event.inputs.mode }} --batch-size ${{ github.event.inputs.batch_size }}
        env:
          # ðŸ” Google Authentication
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          
          # âš™ï¸ System Settings
          NODE_ENV: production
          OPERATION_MODE: fast
          MAX_PLATFORMS: ${{ github.event.inputs.batch_size }}
          DELAY_BETWEEN_ACTIONS: 2000

      - name: Create success report
        if: success()
        run: |
          echo "# ðŸŽ‰ WAHAB System Run Report" > report.md
          echo "" >> report.md
          echo "## Run Details" >> report.md
          echo "- **Date:** $(date)" >> report.md
          echo "- **Mode:** ${{ github.event.inputs.mode }}" >> report.md
          echo "- **Batch Size:** ${{ github.event.inputs.batch_size }}" >> report.md
          echo "- **Status:** âœ… Success" >> report.md
          echo "" >> report.md
          echo "## Google Sheets" >> report.md
          echo "- **Sheet ID:** ${{ secrets.GOOGLE_SHEET_ID }}" >> report.md
          echo "- **View Sheet:** https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit" >> report.md
          echo "" >> report.md
          echo "## Next Steps" >> report.md
          echo "1. Check the Google Sheet for updated status" >> report.md
          echo "2. Run again with different batch size if needed" >> report.md
          echo "3. Monitor results in the sheet" >> report.md
          
          cat report.md

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wahab-report
          path: report.md
          retention-days: 7
