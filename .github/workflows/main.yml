name: WAHAB Referral System
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: true
        default: 'platforms'
        type: choice
        options:
          - platforms
          - users
      batch_size:
        description: 'Number of items to process'
        required: true
        default: '5'
        type: string

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ•ÿµÿØÿßÿ± Docker ÿßŸÑÿ£ÿ≠ÿØÿ´ ŸàÿßŸÑŸÖÿ™ŸàÿßŸÅŸÇ ŸÖÿπ Playwright 1.58.1
    container:
      image: mcr.microsoft.com/playwright:v1.58.1-focal
      options: --user root
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Playwright version
        run: |
          echo "üîç Playwright Version Check"
          echo "Docker Image: mcr.microsoft.com/playwright:v1.58.1-focal"
          npx playwright --version
          
          # ÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπŸÖŸÑ Playwright
          node -e "
          const { chromium } = require('playwright');
          (async () => {
            console.log('üß™ Testing Playwright...');
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            console.log('‚úÖ Playwright is working correctly!');
            await browser.close();
          })();
          "

      - name: Install Google Sheets API
        run: |
          npm init -y
          npm install googleapis
          echo "‚úÖ Google APIs installed"

      - name: Verify Google Sheets access
        run: |
          echo "üîê Testing Google Sheets permissions..."
          node -e "
          const { google } = require('googleapis');
          
          async function testAccess() {
            try {
              const auth = new google.auth.GoogleAuth({
                credentials: {
                  client_email: process.env.GOOGLE_CLIENT_EMAIL,
                  private_key: process.env.GOOGLE_PRIVATE_KEY.replace(/\\\\n/g, '\\\\n')
                },
                scopes: ['https://www.googleapis.com/auth/spreadsheets']
              });
              
              const sheets = google.sheets({ version: 'v4', auth: await auth.getClient() });
              
              // Test READ access
              const sheetInfo = await sheets.spreadsheets.get({
                spreadsheetId: process.env.GOOGLE_SHEET_ID
              });
              console.log('‚úÖ Read access confirmed for:', sheetInfo.data.properties.title);
              
              // Test WRITE access (try to write to a test cell)
              try {
                await sheets.spreadsheets.values.update({
                  spreadsheetId: process.env.GOOGLE_SHEET_ID,
                  range: 'Test!A1',
                  valueInputOption: 'RAW',
                  resource: { values: [['Test Write']] }
                });
                console.log('‚úÖ Write access confirmed');
                
                // Clean up
                await sheets.spreadsheets.values.clear({
                  spreadsheetId: process.env.GOOGLE_SHEET_ID,
                  range: 'Test!A1'
                });
              } catch (writeError) {
                console.log('‚ùå Write access denied. Please share the sheet with:');
                console.log('   Email:', process.env.GOOGLE_CLIENT_EMAIL);
                console.log('   Role: Editor');
                console.log('   Sheet: https://docs.google.com/spreadsheets/d/' + process.env.GOOGLE_SHEET_ID + '/edit');
                console.log('\\nAfter sharing, re-run this workflow.');
                process.exit(1);
              }
              
            } catch (error) {
              console.log('‚ùå Google Sheets access error:', error.message);
              process.exit(1);
            }
          }
          
          testAccess();
          "
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}

      - name: Run WAHAB System
        run: |
          echo "üöÄ Starting WAHAB System"
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Batch size: ${{ github.event.inputs.batch_size }}"
          echo ""
          
          node src/index.js --mode ${{ github.event.inputs.mode }} --batch-size ${{ github.event.inputs.batch_size }}
        env:
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          NODE_ENV: production
          OPERATION_MODE: fast
          MAX_PLATFORMS: ${{ github.event.inputs.batch_size }}
          DELAY_BETWEEN_ACTIONS: 2000

      - name: Success summary
        if: success()
        run: |
          echo "üéâ WAHAB SYSTEM COMPLETED SUCCESSFULLY!"
          echo "======================================"
          echo "‚úÖ All platforms processed"
          echo "‚úÖ Google Sheets updated"
          echo "‚úÖ No errors reported"
          echo ""
          echo "üìä View results in Google Sheets:"
          echo "https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo ""
          echo "üîÑ To run again, go to Actions ‚Üí WAHAB Referral System ‚Üí Run workflow"

      - name: Failure instructions
        if: failure()
        run: |
          echo "üî¥ ACTION REQUIRED:"
          echo "=================="
          echo ""
          echo "If you see 'permission' errors, please:"
          echo ""
          echo "1. Open your Google Sheet:"
          echo "   https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}/edit"
          echo ""
          echo "2. Click 'Share' button"
          echo ""
          echo "3. Add this email address:"
          echo "   ${{ secrets.GOOGLE_CLIENT_EMAIL }}"
          echo ""
          echo "4. Set permission to 'Editor' (NOT 'Viewer')"
          echo ""
          echo "5. Click 'Send'"
          echo ""
          echo "6. Re-run this workflow"
