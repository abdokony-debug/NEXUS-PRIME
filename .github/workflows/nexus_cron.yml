#!/usr/bin/env python3
"""
Smart Outreach System - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†ØŒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ÙˆØ§ÙŠØ§ØŒ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ø¹Ø¨Ø± Ù…Ù†ØµØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
"""

import asyncio
import logging
import signal
import sys
from datetime import datetime
from typing import List, Dict
import schedule
import time

from config.settings import settings
from core.database import DatabaseService
from core.models import Campaign, Lead, LeadStatus, CampaignStatus
from core.analyzer import IntentAnalyzer
from core.rate_limiter import RateLimiter
from services.scraper import ContentScraper
from services.finder import LeadFinder
from services.messenger import MessageSender
from services.reporter import ReportGenerator

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(f"logs/outreach_{datetime.now().strftime('%Y%m%d')}.log"),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

class SmartOutreachSystem:
    """Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ"""
    
    def __init__(self):
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        try:
            settings.validate()
            logger.info("Settings validated successfully")
        except ValueError as e:
            logger.error(f"Settings validation failed: {e}")
            sys.exit(1)
        
        # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
        self.db = DatabaseService()
        self.analyzer = IntentAnalyzer()
        self.rate_limiter = RateLimiter()
        self.finder = LeadFinder()
        self.scraper = ContentScraper()
        self.messenger = MessageSender()
        self.reporter = ReportGenerator(self.db)
        
        # Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        self.is_running = False
        self.current_campaigns: List[Campaign] = []
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
    
    def signal_handler(self, signum, frame):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"""
        logger.info(f"Received signal {signum}. Shutting down gracefully...")
        self.is_running = False
    
    async def start(self):
        """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…"""
        logger.info("ğŸš€ Starting Smart Outreach System...")
        self.is_running = True
        
        try:
            # Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
            self._setup_scheduled_tasks()
            
            # Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            while self.is_running:
                await self._process_cycle()
                await asyncio.sleep(60)  # Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ù‚ÙŠÙ‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        
        except Exception as e:
            logger.error(f"System error: {e}", exc_info=True)
        finally:
            await self.shutdown()
    
    def _setup_scheduled_tasks(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©"""
        # ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ù‹Ø§
        schedule.every().day.at("08:00").do(self._generate_daily_report)
        
        # ÙØ­Øµ Ø§Ù„Ø­Ù…Ù„Ø§Øª ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
        schedule.every(30).minutes.do(self._check_campaigns)
        
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§
        schedule.every().day.at("00:00").do(self._cleanup_old_data)
        
        logger.info("Scheduled tasks configured")
    
    async def _process_cycle(self):
        """Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
        try:
            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
            schedule.run_pending()
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            await self._process_active_campaigns()
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ÙŠØ­ØªØ§Ø¬ÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ø©
            await self._process_followups()
            
        except Exception as e:
            logger.error(f"Process cycle error: {e}")
    
    async def _process_active_campaigns(self):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©"""
        try:
            campaigns = self.db.get_active_campaigns()
            
            for campaign in campaigns:
                if not self.is_running:
                    break
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡
                campaign_stats = self.db.get_campaign_stats(campaign.id)
                if campaign_stats.get('total_leads', 0) >= campaign.max_leads:
                    logger.info(f"Campaign {campaign.name} reached max leads limit")
                    self.db.update_campaign_status(campaign.id, CampaignStatus.COMPLETED)
                    continue
                
                logger.info(f"Processing campaign: {campaign.name}")
                await self._process_single_campaign(campaign)
                
                # Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ† Ø§Ù„Ø­Ù…Ù„Ø§Øª
                await asyncio.sleep(5)
        
        except Exception as e:
            logger.error(f"Error processing campaigns: {e}")
    
    async def _process_single_campaign(self, campaign: Campaign):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ù…Ù„Ø© ÙØ±Ø¯ÙŠØ©"""
        try:
            async with self.finder as finder:
                # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­ØªÙ…Ù„ÙŠÙ†
                logger.info(f"Searching for leads for campaign: {campaign.name}")
                search_results = await finder.search_leads(
                    keywords=campaign.keywords,
                    platforms=campaign.target_platforms,
                    max_results=min(20, campaign.max_leads),
                    region=campaign.target_regions[0] if campaign.target_regions else ""
                )
                
                logger.info(f"Found {len(search_results)} potential leads")
                
                # Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ù†ØªÙŠØ¬Ø©
                async with self.scraper as scraper:
                    for result in search_results:
                        if not self.is_running:
                            break
                        
                        try:
                            await self._process_potential_lead(result, campaign, scraper)
                            await asyncio.sleep(2)  # ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                        
                        except Exception as e:
                            logger.error(f"Error processing lead {result.get('url')}: {e}")
        
        except Exception as e:
            logger.error(f"Error in campaign processing: {e}")
    
    async def _process_potential_lead(self, result: Dict, campaign: Campaign, scraper: ContentScraper):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„"""
        url = result.get('url')
        if not url:
            return
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        scrape_data = await scraper.scrape_url(url)
        
        if not scrape_data.get('content'):
            logger.warning(f"No content extracted from {url}")
            return
        
        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ÙŠØ©
        analysis = self.analyzer.analyze_content(scrape_data['content'], url)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù†Ù‚Ø§Ø·
        if analysis['overall_score'] < campaign.min_intent_score:
            logger.info(f"Lead score {analysis['overall_score']} below threshold for {url}")
            return
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
        lead = Lead(
            campaign_id=campaign.id,
            url=url,
            platform=scrape_data['platform'],
            name=scrape_data.get('author', ''),
            email=scrape_data.get('contact_info', {}).get('email', ''),
            company=scrape_data.get('company', ''),
            job_title=scrape_data.get('job_title', ''),
            location=scrape_data.get('location', ''),
            intent_score=analysis['overall_score'],
            sentiment_score=analysis['sentiment'].get('score', 0),
            relevance_score=analysis['overall_score'] * 0.8,  # ØªÙ‚Ø¯ÙŠØ±ÙŠ
            content_summary=scrape_data['content'][:500] if scrape_data['content'] else '',
            engagement_metrics=scrape_data.get('engagement_metrics', {}),
            contact_info=scrape_data.get('contact_info', {}),
            status=LeadStatus.NEW
        )
        
        # Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if self.db.insert_lead(lead):
            logger.info(f"âœ… Lead saved: {url} (Score: {lead.intent_score})")
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‚Ø·Ø© Ø¹Ø§Ù„ÙŠØ©
            if lead.intent_score >= 85:
                await self._attempt_immediate_outreach(lead, campaign)
        else:
            logger.warning(f"Failed to save lead: {url}")
    
    async def _attempt_immediate_outreach(self, lead: Lead, campaign: Campaign):
        """Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø°ÙˆÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¹Ø§Ù„ÙŠØ©"""
        try:
            # Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ Ù…Ù†ØµØ© Ù„Ù„Ø§ØªØµØ§Ù„
            platform = self._select_best_platform(lead)
            
            if not platform:
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            if not self.rate_limiter.can_send(platform.value, lead.campaign_id):
                logger.info(f"Rate limit reached for {platform.value}")
                return
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
            campaign_data = {
                'product_name': campaign.name,
                'usp': campaign.usp,
                'product_link': campaign.product_link,
                'signature': 'Best regards,\nSmart Outreach Team'
            }
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            success, response = await self.messenger.send_message(lead, campaign_data, platform)
            
            if success:
                lead.status = LeadStatus.CONTACTED
                lead.message_sent = True
                lead.last_contacted = datetime.now()
                
                self.db.update_lead(lead)
                self.rate_limiter.record_send(platform.value, lead.campaign_id)
                
                logger.info(f"âœ… Immediate outreach successful via {platform.value}")
            else:
                logger.warning(f"Immediate outreach failed: {response}")
        
        except Exception as e:
            logger.error(f"Error in immediate outreach: {e}")
    
    def _select_best_platform(self, lead: Lead):
        """Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ Ù…Ù†ØµØ© Ù„Ù„Ø§ØªØµØ§Ù„"""
        # Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ø°Ø§ Ù…ØªÙˆÙØ±ØŒ Ø«Ù… Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        if lead.email:
            from core.models import Platform
            return Platform.EMAIL
        else:
            return lead.platform
    
    async def _process_followups(self):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª"""
        try:
            # Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù… ÙˆÙ„Ù… ÙŠØ±Ø¯ÙˆØ§
            # (ØªØ·Ø¨ÙŠÙ‚ Ù…ØªÙ‚Ø¯Ù… ÙŠØªØ·Ù„Ø¨ ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø¯ÙˆØ¯)
            pass
        
        except Exception as e:
            logger.error(f"Error processing followups: {e}")
    
    def _generate_daily_report(self):
        """ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ"""
        try:
            report = self.reporter.generate_dashboard_report()
            
            # Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            report_file = f"reports/dashboard_{timestamp}.json"
            
            import json
            with open(report_file, 'w', encoding='utf-8') as f:
                json.dump(report, f, indent=2, ensure_ascii=False)
            
            logger.info(f"Daily report generated: {report_file}")
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            # self._send_report_email(report)
        
        except Exception as e:
            logger.error(f"Error generating daily report: {e}")
    
    def _check_campaigns(self):
        """ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª"""
        try:
            campaigns = self.db.get_active_campaigns()
            
            for campaign in campaigns:
                stats = self.db.get_campaign_stats(campaign.id)
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¹Ù…Ù„Ø§Ø¡
                if stats.get('total_leads', 0) == 0:
                    logger.warning(f"Campaign {campaign.name} has no leads after 24 hours")
                    # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù‡Ù†Ø§
        
        except Exception as e:
            logger.error(f"Error checking campaigns: {e}")
    
    def _cleanup_old_data(self):
        """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©"""
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ØªØ·Ø¨ÙŠÙ‚ Ù…ØªÙ‚Ø¯Ù…)
        pass
    
    async def shutdown(self):
        """Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø´ÙƒÙ„ Ù…Ø±ØªØ¨"""
        logger.info("Shutting down Smart Outreach System...")
        
        # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª
        for campaign in self.current_campaigns:
            self.db.update_campaign_status(campaign.id, CampaignStatus.PAUSED)
        
        logger.info("Shutdown complete")

async def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    system = SmartOutreachSystem()
    
    try:
        await system.start()
    except KeyboardInterrupt:
        logger.info("System stopped by user")
    except Exception as e:
        logger.error(f"Fatal error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    import os
    os.makedirs("logs", exist_ok=True)
    os.makedirs("reports", exist_ok=True)
    os.makedirs("data", exist_ok=True)
    
    # Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
    asyncio.run(main())
